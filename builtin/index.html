<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name=apple-mobile-web-app-capable content=yes>
<meta name=apple-mobile-web-app-status-bar-style content=black>

<style>
body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  position: fixed;
  background: #000;
  user-select: none;
}

#error {
  padding: 1em;
  margin: 0;
  display: none;
  background: #fff;
  color: #e40046;
  font-size: 1.125em;
  font-family: Source Code Pro, Monaco, Menlo, monospace;
  white-space: pre-wrap;
}
</style>

<body>
<pre id=error></pre>

<script src="gyronorm.js"></script>
<script src="pep.js"></script>
<script src="uw.built.js"></script>

<script>
const stackTrace = document.querySelector('#error')
const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:'
const host = location.host
var ws
function connect() {
  ws = new WebSocket(`${protocol}//${host}/ws`)
  ws.addEventListener('message', onMessage)
  ws.addEventListener('close', () => setTimeout(connect, 1000))
  ws.addEventListener('open', () => console.log('watching'))
}
connect()

function onMessage(e) {
  const json = JSON.parse(e.data)
  if (json._type === 'refresh') {
    console.log('refreshing')
    refresh()
  }
}

var isRefreshing = false
function refresh() {
  if (isRefreshing) return
  isRefreshing = true
  const error = () => { isRefreshing = false; setTimeout(refresh, 100) }
  const xhr = new XMLHttpRequest
  const url = 'app.js?' + (new Date|0)
  xhr.open('GET', url, true)
  xhr.onload = function() {
    if (xhr.status === 200) {
      UW.destroy()
      stackTrace.style.display = 'none'
      seenError = false
      document.body.removeChild(document.querySelector('#game'))

      // now it's in cache!
      isRefreshing = false
      const script = document.createElement('script')
      script.setAttribute('id', 'game')
      script.setAttribute('src', url)
      document.body.appendChild(script)
    } else {
      error()
    }
  }
  xhr.onerror = error
  xhr.responseType = 'text'
  xhr.send()
}

var seenError = false
window.addEventListener('error', showError)

function showError(msg, source, line, col, err) {
  if (seenError) return
  seenError = true
  var err = err || msg
  var line = line || err.lineno || 'unknown'
  if (!source || /\/app.js$/.test(source)) {
    stackTrace.textContent = (err.stack || err.message || err) + '\n  â‡’ line ' + line
    stackTrace.style.display = 'block'
  }
}
</script>

<script id=game src="app.js"></script>

