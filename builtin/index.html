<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name=apple-mobile-web-app-capable content=yes>
<meta name=apple-mobile-web-app-status-bar-style content=black>

<style>
body {
  overflow: hidden;
  position: fixed;
  background: #000;
}

#error {
  padding: 1em;
  margin: 0;
  display: none;
  background: #fff;
  color: #e40046;
  font-size: 1.125em;
  font-family: Source Code Pro, Monaco, Menlo, monospace;
}
</style>

<body>
<pre id=error></pre>

<script src="gyronorm.js"></script>
<script src="uw.built.js"></script>

<script>
const stackTrace = document.querySelector('#error')
const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:'
const host = location.host
var ws
function connect() {
  ws = new WebSocket(`${protocol}//${host}/ws`)
  ws.addEventListener('message', onMessage)
  ws.addEventListener('close', () => setTimeout(connect, 1000))
  ws.addEventListener('open', () => console.log('watching'))
}
connect()

function onMessage(e) {
  const json = JSON.parse(e.data)
  if (json._type === 'refresh') {
    console.log('refreshing')
    refresh()
  }
}

var isRefreshing = false
function refresh() {
  if (isRefreshing) return
  isRefreshing = true
  const error = () => { isRefreshing = false; setTimeout(refresh, 100) }
  const xhr = new XMLHttpRequest
  xhr.open('GET', 'app.js', true)
  xhr.onload = function() {
    if (xhr.status === 200) {
      UW.destroy()
      isRefreshing = false
      try {
        stackTrace.style.display = 'none'
        eval(xhr.responseText)
      } catch (err) {
        stackTrace.textContent = err.stack
        stackTrace.style.display = 'block'
      }
    } else {
      error()
    }
  }
  xhr.onerror = error
  xhr.responseType = 'text'
  xhr.send()
}

window.onerror = (msg, source, line, col, err) => {
  if (/\/app.js$/.test(source)) {
    stackTrace.textContent = err.stack + '\n  â‡’ app.js, line ' + line
    stackTrace.style.display = 'block'
  }
}
</script>

<script src="app.js"></script>
