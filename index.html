<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name=apple-mobile-web-app-capable content=yes>
<meta name=apple-mobile-web-app-status-bar-style content=black>

<style>
body {
  overflow: hidden;
  position: fixed;
  background: #000;
}
</style>
<body>
<script src=uw/gyronorm.js></script>
<script src=uw/emitter.js></script>
<script src=uw/emojis.js></script>
<script src=uw/sprites.js></script>
<script>
var {forever, Phone, Costume, Sprite, World} = UW
var world
var phone = new Phone()

var debug = document.createElement('pre')

UW.init({
  smile: 'https://emojipedia-us.s3.amazonaws.com/thumbs/320/emoji-one/104/grinning-face_1f600.png',
  platform: Costume.emoji('➖'), //Costume.emoji('🕳️'),
  bird: Costume.emoji('🐦'),
}, () => {

  world = new World({
    background: '#fff',
  })
  //world._root.appendChild(debug)

  var scrollVel = 0

  var player = new Sprite('bird', {
    scale: 5,
  })
  player.yVel = 0
  forever(() => {
    // move horizontally
    var xVel = 10 * UW.sin(phone.zAngle)
    if (xVel > 1) player.flipped = true
    if (xVel < -1) player.flipped = false
    player.x += xVel

    // crash into walls
    if (player.x < 72) player.x = 72
    if (player.x > world.width - 72) player.x = world.width - 72

    // fall down
    player.y += player.yVel
    player.yVel -= 1

    // temp
    if (player.y + world.scrollY < 72) { 
      player.yVel = 42
    }

    // bounce off platforms
    // if (player.yVel < 0) {
    //   for (var other of player.touching()) {
    //     if (other.isPlatform) {
    //       player.yVel = 42
    //     }
    //   }
    // }

    // scroll up, if we're near the top of the screen
    const barrier = world.height * 0.75
    const diff = (player.y + world.scrollY) - barrier
    if (diff > 0) {
      world.scrollY -= diff
    }
  })

  function makePlatform() {
    count += 1
    lastPlatform = new Sprite('platform', {
      x: Math.random() * world.width,
      y: 200 * count,
      scale: 6,
      isPlatform: true,
    })
    platforms.push(lastPlatform)

    // make sure the player is on top
    player.raise()
  }

  function destroyPlatform() {
    platforms.shift().destroy()
  }

  var count = 0
  var platforms = []
  var lastPlatform
  makePlatform()
  forever(() => {
    if (lastPlatform.y + world.scrollY < world.height * 2) {
      makePlatform()
    } else if (platforms[0].y + world.scrollY < -world.height) {
      destroyPlatform()
    }
  })

  world.start()

})

</script>

